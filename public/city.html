<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Schools in City - Better School UK">
    <title id="pageTitle">City Schools - Better School UK</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Main CSS -->
    <link rel="stylesheet" href="/css/styles.css">
    
    <style>
        .city-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 0;
        }
        
        .city-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .city-subtitle {
            font-size: 1.125rem;
            opacity: 0.9;
        }
        
        .stats-bar {
            background: white;
            padding: 1.5rem 0;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 2rem;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 2rem;
            text-align: center;
        }
        
        .stat {
            padding: 1rem;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2563eb;
            display: block;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .sidebar-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            height: fit-content;
            border: 1px solid #e5e7eb;
        }
        
        .sidebar-section {
            margin-bottom: 2rem;
        }
        
        .sidebar-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: #374151;
        }
        
        .sidebar-link {
            display: block;
            padding: 0.5rem 0;
            color: #6b7280;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .sidebar-link:hover {
            color: #2563eb;
        }
        
        .sidebar-link.active {
            color: #2563eb;
            font-weight: 500;
        }
        
        .main-content {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
        }
        
        .schools-list {
            margin-top: 1rem;
        }
        
        .filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .filter-select {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }
        
        .loading-message {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        
        .error-message {
            text-align: center;
            padding: 2rem;
            color: #ef4444;
            background: #fee;
            border-radius: 8px;
        }
        
        @media (max-width: 768px) {
            .sidebar-layout {
                grid-template-columns: 1fr;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header"></div>
    
    <!-- City Header -->
    <section class="city-header">
        <div class="container">
            <h1 class="city-title" id="cityName">Loading...</h1>
            <p class="city-subtitle" id="cityDescription">Schools in this area</p>
        </div>
    </section>
    
    <!-- Stats Bar -->
    <section class="stats-bar">
        <div class="container">
            <div class="stats-container">
                <div class="stat">
                    <span class="stat-number" id="totalSchools">-</span>
                    <span class="stat-label">Total Schools</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="primarySchools">-</span>
                    <span class="stat-label">Primary Schools</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="secondarySchools">-</span>
                    <span class="stat-label">Secondary Schools</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="outstandingSchools">-</span>
                    <span class="stat-label">Outstanding</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="goodSchools">-</span>
                    <span class="stat-label">Good Schools</span>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Main Content -->
    <div class="container">
        <div class="sidebar-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Schools</h3>
                    <a href="#" class="sidebar-link active" data-filter="all">All Schools</a>
                    <a href="#" class="sidebar-link" data-filter="primary">Primary Schools</a>
                    <a href="#" class="sidebar-link" data-filter="secondary">Secondary Schools</a>
                    <a href="#" class="sidebar-link" data-filter="sixth-form">Sixth Form Colleges</a>
                </div>
                
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Local Authorities</h3>
                    <div id="localAuthorities">
                        <!-- Will be populated -->
                    </div>
                </div>
            </aside>
            
            <!-- Main Content Area -->
            <main class="main-content">
                <h2>Schools in <span id="cityNameInline">this city</span></h2>
                
                <!-- Filter Bar -->
                <div class="filter-bar">
                    <select class="filter-select" id="phaseFilter">
                        <option value="">All Phases</option>
                        <option value="Primary">Primary</option>
                        <option value="Secondary">Secondary</option>
                        <option value="16 plus">Sixth Form</option>
                        <option value="All-through">All-through</option>
                    </select>
                    
                    <select class="filter-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="Academy">Academy</option>
                        <option value="Community school">Community School</option>
                        <option value="Voluntary aided school">Voluntary Aided</option>
                        <option value="Foundation school">Foundation School</option>
                    </select>
                    
                    <select class="filter-select" id="ofstedFilter">
                        <option value="">All Ratings</option>
                        <option value="1">Outstanding</option>
                        <option value="2">Good</option>
                        <option value="3">Requires Improvement</option>
                        <option value="4">Inadequate</option>
                    </select>
                    
                    <select class="filter-select" id="sortBy">
                        <option value="rating">Sort by Rating</option>
                        <option value="name">Sort by Name</option>
                        <option value="ofsted">Sort by Ofsted</option>
                    </select>
                </div>
                
                <!-- Schools List -->
                <div id="schoolsList" class="schools-list">
                    <div class="loading-message">
                        <p>Loading schools...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Footer -->
    <div id="footer"></div>
    
    <!-- Scripts -->
    <script src="/js/main.js"></script>
    <script>
        // Get city from URL
        const citySlug = window.location.pathname.split('/')[1];
        
        // City configuration with London boroughs
        const cityConfig = {
            'london': {
                name: 'London',
                searchTerms: [
                    'Westminster', 'Camden', 'Islington', 'Hackney', 'Tower Hamlets', 
                    'Greenwich', 'Lewisham', 'Southwark', 'Lambeth', 'Wandsworth', 
                    'Hammersmith and Fulham', 'Kensington and Chelsea', 'Brent', 'Ealing', 
                    'Hounslow', 'Richmond upon Thames', 'Kingston upon Thames', 'Merton', 
                    'Sutton', 'Croydon', 'Bromley', 'Bexley', 'Havering', 'Barking and Dagenham', 
                    'Redbridge', 'Newham', 'Waltham Forest', 'Haringey', 'Enfield', 
                    'Barnet', 'Harrow', 'Hillingdon', 'City of London'
                ]
            },
            'manchester': {
                name: 'Manchester',
                searchTerms: ['Manchester', 'Salford', 'Trafford', 'Stockport', 'Tameside', 'Oldham', 'Rochdale', 'Bury', 'Bolton', 'Wigan']
            },
            'birmingham': {
                name: 'Birmingham',
                searchTerms: ['Birmingham']
            },
            'glasgow': {
                name: 'Glasgow',
                searchTerms: ['Glasgow City']
            },
            'liverpool': {
                name: 'Liverpool',
                searchTerms: ['Liverpool']
            },
            'bristol': {
                name: 'Bristol',
                searchTerms: ['Bristol, City of']
            },
            'sheffield': {
                name: 'Sheffield',
                searchTerms: ['Sheffield']
            },
            'leeds': {
                name: 'Leeds',
                searchTerms: ['Leeds']
            },
            'edinburgh': {
                name: 'Edinburgh',
                searchTerms: ['City of Edinburgh']
            },
            'leicester': {
                name: 'Leicester',
                searchTerms: ['Leicester']
            }
        };
        
        // Default config for cities not in the list
        const defaultConfig = {
            name: citySlug.charAt(0).toUpperCase() + citySlug.slice(1).replace(/-/g, ' '),
            searchTerms: [citySlug.charAt(0).toUpperCase() + citySlug.slice(1).replace(/-/g, ' ')]
        };
        
        const cityInfo = cityConfig[citySlug] || defaultConfig;
        const cityName = cityInfo.name;
        
        // Store all schools for filtering
        let allSchools = [];
        let currentFilter = {
            phase: '',
            type: '',
            ofsted: '',
            sort: 'rating'
        };
        
        // Update page elements
        document.getElementById('cityName').textContent = cityName;
        document.getElementById('cityNameInline').textContent = cityName;
        document.getElementById('cityDescription').textContent = `Browse and compare schools in ${cityName}`;
        document.getElementById('pageTitle').textContent = `${cityName} Schools - Better School UK`;
        
        // Load schools for this city
        async function loadCitySchools() {
            try {
                const schoolsList = document.getElementById('schoolsList');
                schoolsList.innerHTML = '<div class="loading-message"><p>Loading schools...</p></div>';
                
                const allSchoolsSet = new Map(); // Use Map to prevent duplicates by URN
                
                // Search for each term separately
                for (const searchTerm of cityInfo.searchTerms) {
                    try {
                        console.log(`Searching for: ${searchTerm}`);
                        const response = await fetch(`/api/search?q=${encodeURIComponent(searchTerm)}&type=location&limit=500`);
                        const data = await response.json();
                        
                        if (data.success && data.schools) {
                            console.log(`Found ${data.schools.length} schools for ${searchTerm}`);
                            data.schools.forEach(school => {
                                allSchoolsSet.set(school.urn, school);
                            });
                        }
                    } catch (error) {
                        console.error(`Error searching for ${searchTerm}:`, error);
                    }
                }
                
                // Convert Map to array
                allSchools = Array.from(allSchoolsSet.values());
                console.log(`Total unique schools found: ${allSchools.length}`);
                
                if (allSchools.length === 0) {
                    schoolsList.innerHTML = '<div class="error-message">No schools found in this area. The search may need to be refined.</div>';
                    updateStats([]);
                    return;
                }
                
                // Sort schools by rating initially
                allSchools.sort((a, b) => (b.overall_rating || 0) - (a.overall_rating || 0));
                
                displayCitySchools(allSchools);
                updateStats(allSchools);
                updateLocalAuthorities(allSchools);
                
            } catch (error) {
                console.error('Error loading city schools:', error);
                document.getElementById('schoolsList').innerHTML = 
                    '<div class="error-message">Error loading schools. Please try again.</div>';
            }
        }
        
        function displayCitySchools(schools) {
            const container = document.getElementById('schoolsList');
            
            if (!schools || schools.length === 0) {
                container.innerHTML = '<p>No schools found matching your filters.</p>';
                return;
            }
            
            // Apply filters
            let filteredSchools = schools.filter(school => {
                if (currentFilter.phase && school.phase_of_education !== currentFilter.phase) return false;
                if (currentFilter.type && school.type_of_establishment !== currentFilter.type) return false;
                if (currentFilter.ofsted && school.ofsted_rating != currentFilter.ofsted) return false;
                return true;
            });
            
            // Apply sorting
            filteredSchools.sort((a, b) => {
                switch (currentFilter.sort) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'ofsted':
                        return (a.ofsted_rating || 5) - (b.ofsted_rating || 5);
                    case 'rating':
                    default:
                        return (b.overall_rating || 0) - (a.overall_rating || 0);
                }
            });
            
            const html = filteredSchools.map(school => {
                const schoolUrl = `/${citySlug}/${school.urn}`;
                
                return `
                    <div class="school-card" onclick="window.location.href='${schoolUrl}'">
                        <div class="school-card-header">
                            <div>
                                <div class="school-card-name">${school.name}</div>
                                <div class="school-card-type">${school.type_of_establishment || ''} • ${school.phase_of_education || ''}</div>
                            </div>
                            <div class="school-card-rating rating-${getRatingClass(school.overall_rating)}">
                                ${school.overall_rating || '-'}/10
                            </div>
                        </div>
                        <div class="school-card-details">
                            <div class="detail-item">
                                <span>📍</span>
                                <span>${school.local_authority || school.town || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <span>🎓</span>
                                <span>Ofsted: ${getOfstedLabel(school.ofsted_rating)}</span>
                            </div>
                            <div class="detail-item">
                                <span>👥</span>
                                <span>${school.number_on_roll || 'N/A'} students</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html || '<p>No schools found matching your filters.</p>';
        }
        
        function updateStats(schools) {
            document.getElementById('totalSchools').textContent = schools.length;
            
            const primary = schools.filter(s => s.phase_of_education === 'Primary').length;
            const secondary = schools.filter(s => s.phase_of_education === 'Secondary').length;
            const outstanding = schools.filter(s => s.ofsted_rating === 1).length;
            const good = schools.filter(s => s.ofsted_rating === 2).length;
            
            document.getElementById('primarySchools').textContent = primary;
            document.getElementById('secondarySchools').textContent = secondary;
            document.getElementById('outstandingSchools').textContent = outstanding;
            document.getElementById('goodSchools').textContent = good;
        }
        
        function updateLocalAuthorities(schools) {
            const las = [...new Set(schools.map(s => s.local_authority).filter(la => la))];
            const container = document.getElementById('localAuthorities');
            
            container.innerHTML = las.slice(0, 10).map(la => 
                `<a href="#" class="sidebar-link" onclick="filterByLA('${la}')">${la}</a>`
            ).join('');
        }
        
        function getRatingClass(rating) {
            if (!rating) return 'average';
            if (rating >= 8) return 'excellent';
            if (rating >= 6) return 'good';
            if (rating >= 4) return 'satisfactory';
            return 'poor';
        }
        
        function getOfstedLabel(rating) {
            const labels = {
                1: 'Outstanding',
                2: 'Good',
                3: 'Requires Improvement',
                4: 'Inadequate'
            };
            return labels[rating] || 'Not Inspected';
        }
        
        function filterByLA(la) {
            const filtered = allSchools.filter(s => s.local_authority === la);
            displayCitySchools(filtered);
        }
        
        // Filter event listeners
        document.getElementById('phaseFilter').addEventListener('change', (e) => {
            currentFilter.phase = e.target.value;
            displayCitySchools(allSchools);
        });
        
        document.getElementById('typeFilter').addEventListener('change', (e) => {
            currentFilter.type = e.target.value;
            displayCitySchools(allSchools);
        });
        
        document.getElementById('ofstedFilter').addEventListener('change', (e) => {
            currentFilter.ofsted = e.target.value;
            displayCitySchools(allSchools);
        });
        
        document.getElementById('sortBy').addEventListener('change', (e) => {
            currentFilter.sort = e.target.value;
            displayCitySchools(allSchools);
        });
        
        // Sidebar filter links
        document.querySelectorAll('.sidebar-link[data-filter]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.sidebar-link[data-filter]').forEach(l => l.classList.remove('active'));
                e.target.classList.add('active');
                
                const filter = e.target.dataset.filter;
                if (filter === 'all') {
                    currentFilter.phase = '';
                } else if (filter === 'primary') {
                    currentFilter.phase = 'Primary';
                } else if (filter === 'secondary') {
                    currentFilter.phase = 'Secondary';
                } else if (filter === 'sixth-form') {
                    currentFilter.phase = '16 plus';
                }
                
                document.getElementById('phaseFilter').value = currentFilter.phase;
                displayCitySchools(allSchools);
            });
        });
        
        // Load schools on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCitySchools();
        });
    </script>
</body>
</html>