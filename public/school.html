<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="School Profile - Better School UK">
  <title id="pageTitle">School Profile - Better School UK</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Leaflet CSS and JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Main CSS -->
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/school-profile.css">
</head>
<body>
  <!-- Header will be loaded dynamically -->
  <div id="header"></div>

  <!-- Breadcrumb will be loaded dynamically -->
  <div id="breadcrumb"></div>

  <!-- School Header Section - loaded via component -->
  <div id="schoolHeader"></div>

  <!-- Key Stats Bar - loaded via component -->
  <div id="keyStats"></div>

  <section class="container" style="margin-top:2rem;">
    <div class="profile-content">
      <div class="main-content">
        
        <!-- Test Scores Section - loaded via component -->
        <div id="testScores"></div>

        <!-- School Information Section -->
        <div id="schoolInfo" class="section-card"></div>

        <!-- Ofsted Inspection Section -->
        <div id="ofstedSection" class="section-card"></div>

        <!-- Contact & Location Section -->
        <div class="section-card">
          <div class="section-header">
            <h2 class="section-title">Contact & Location</h2>
          </div>
          <div class="neighborhood">
            <div id="contactCard"></div>
            <div>
              <div id="schoolMap" style="height: 400px; border-radius: 8px; border: 1px solid #e5e7eb;"></div>
              <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                Map showing school location
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Sidebar -->
      <aside class="sidebar">
        <div id="actionButtons" class="sidebar-section"></div>
        <div id="nearbySchools" class="sidebar-section"></div>
      </aside>
    </div>
  </section>

  <!-- Footer will be loaded dynamically -->
  <div id="footer" style="margin-top:4rem;"></div>

  <!-- Load component scripts -->
  <script src="/js/main.js"></script>
  <script src="/js/schoolComponents.js"></script>
  
  <script>
    // Main initialization
    class SchoolPage {
      constructor() {
        this.urn = this.getURNFromPath();
        this.school = null;
        this.init();
      }

      getURNFromPath() {
        const parts = window.location.pathname.split('/').filter(Boolean);
        if (parts[0] === 'school' && parts[1]) {
          return parts[1];
        } else if (parts.length === 2 && !isNaN(Number(parts[1]))) {
          return parts[1];
        }
        return null;
      }

      async init() {
        if (!this.urn) {
          this.showError('Invalid school URL');
          return;
        }

        // Load header and footer
        this.loadCommonComponents();
        
        // Load school data
        await this.loadSchoolData();
        
        // Render components
        if (this.school) {
          this.renderSchoolComponents();
          this.loadAdditionalData();
        }
      }

      loadCommonComponents() {
        // Load header
        fetch('/components/header.html')
          .then(r => r.text())
          .then(html => document.getElementById('header').innerHTML = html)
          .catch(console.error);
        
        // Load footer
        fetch('/components/footer.html')
          .then(r => r.text())
          .then(html => document.getElementById('footer').innerHTML = html)
          .catch(console.error);
        
        // Render breadcrumb
        this.renderBreadcrumb();
      }

      renderBreadcrumb() {
        const parts = window.location.pathname.split('/').filter(Boolean);
        let city = null;
        
        if (parts.length === 2 && !isNaN(Number(parts[1]))) {
          city = parts[0];
        }
        
        const breadcrumb = `
          <div class="breadcrumb">
            <div class="container">
              <ol class="breadcrumb-list">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-separator">/</li>
                <li class="breadcrumb-item"><a href="/search">Search</a></li>
                ${city ? `
                <li class="breadcrumb-separator">/</li>
                <li class="breadcrumb-item"><a href="/${city}">${city.charAt(0).toUpperCase() + city.slice(1).replace(/-/g,' ')}</a></li>
                ` : ''}
                <li class="breadcrumb-separator">/</li>
                <li class="breadcrumb-item active" id="schoolCrumb">School</li>
              </ol>
            </div>
          </div>
        `;
        document.getElementById('breadcrumb').innerHTML = breadcrumb;
      }

      async loadSchoolData() {
        try {
          const response = await fetch(`/api/schools/${this.urn}`);
          const data = await response.json();
          
          if (!data.success || !data.school) {
            this.showError('School not found');
            return;
          }
          
          this.school = data.school;
          
          // Update page title and breadcrumb
          document.getElementById('pageTitle').textContent = `${this.school.name} - Better School UK`;
          const crumb = document.getElementById('schoolCrumb');
          if (crumb) crumb.textContent = this.school.name;
          
        } catch (error) {
          console.error('Error loading school:', error);
          this.showError('Error loading school data');
        }
      }

      renderSchoolComponents() {
        // Render header section
        document.getElementById('schoolHeader').innerHTML = 
          SchoolComponents.renderSchoolHeader(this.school);
        
        // Render key stats
        document.getElementById('keyStats').innerHTML = 
          SchoolComponents.renderKeyStats(this.school);
        
        // Render test scores
        document.getElementById('testScores').innerHTML = 
          SchoolComponents.renderTestScores(this.school);
        
        // Render school info
        this.renderSchoolInfo();
        
        // Render Ofsted section
        this.renderOfstedSection();
        
        // Render contact card
        document.getElementById('contactCard').innerHTML = 
          SchoolComponents.renderContactCard(this.school);
        
        // Initialize map
        setTimeout(() => {
          SchoolComponents.renderMap('schoolMap', this.school);
        }, 100);
        
        // Render sidebar
        this.renderSidebar();
      }

      renderSchoolInfo() {
        const info = `
          <div class="section-header">
            <h2 class="section-title">School Information</h2>
          </div>
          <div class="info-list">
            <div class="info-row">
              <span class="info-label">School Type</span>
              <span class="info-value">${this.school.type || '-'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Gender</span>
              <span class="info-value">${this.school.characteristics?.gender || '-'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Age Range</span>
              <span class="info-value">${this.school.characteristics?.age_range || '-'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Religious Character</span>
              <span class="info-value">${this.school.characteristics?.religious_character || 'None'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Admissions Policy</span>
              <span class="info-value">${this.school.characteristics?.admissions_policy || 'Standard'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Local Authority</span>
              <span class="info-value">${this.school.address?.local_authority || '-'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">URN</span>
              <span class="info-value">${this.school.urn || '-'}</span>
            </div>
          </div>
        `;
        document.getElementById('schoolInfo').innerHTML = info;
      }

      renderOfstedSection() {
        if (!this.school.ofsted) {
          document.getElementById('ofstedSection').style.display = 'none';
          return;
        }
        
        const ratings = [
          { label: 'Overall Effectiveness', value: this.school.ofsted.overall_label },
          { label: 'Quality of Education', value: this.getOfstedLabel(this.school.ofsted.quality_of_education) },
          { label: 'Behaviour & Attitudes', value: this.getOfstedLabel(this.school.ofsted.behaviour_and_attitudes) },
          { label: 'Personal Development', value: this.getOfstedLabel(this.school.ofsted.personal_development) },
          { label: 'Leadership & Management', value: this.getOfstedLabel(this.school.ofsted.leadership_and_management) },
          { label: 'Safeguarding', value: this.school.ofsted.safeguarding_effective || '-' }
        ];
        
        const ofsted = `
          <div class="section-header">
            <h2 class="section-title">Ofsted Inspection</h2>
            <span style="font-size:.875rem;color:#6b7280;">
              ${this.school.ofsted.inspection_date ? new Date(this.school.ofsted.inspection_date).toLocaleDateString() : '-'}
            </span>
          </div>
          <div class="performance-grid">
            ${ratings.map(r => `
              <div class="performance-item">
                <div class="performance-label">${r.label}</div>
                <div class="performance-value" style="font-size:1rem;">${r.value || '-'}</div>
              </div>
            `).join('')}
          </div>
          ${this.school.ofsted.web_link ? `
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
            <a href="${this.school.ofsted.web_link}" target="_blank" rel="noopener" style="color: #2563eb; text-decoration: none; font-size: 0.875rem;">
              View full Ofsted report →
            </a>
          </div>` : ''}
        `;
        document.getElementById('ofstedSection').innerHTML = ofsted;
      }

      renderSidebar() {
        // Action buttons
        const actions = `
          <div class="action-buttons" style="display:flex;flex-direction:column;gap:.75rem">
            <button class="action-btn primary" onclick="alert('Save coming soon')">⭐ Save School</button>
            <button class="action-btn" onclick="alert('Compare coming soon')">📊 Compare</button>
            <button class="action-btn" onclick="navigator.share ? navigator.share({title:document.title,url:location.href}) : alert('Share coming soon')">🔗 Share</button>
            <button class="action-btn" onclick="window.print()">🖨️ Print</button>
          </div>
        `;
        document.getElementById('actionButtons').innerHTML = actions;
        
        // Nearby schools will be loaded separately
        document.getElementById('nearbySchools').innerHTML = `
          <h3 class="sidebar-title">Nearby Schools</h3>
          <div id="nearbySchoolsList">Loading...</div>
        `;
      }

      async loadAdditionalData() {
        // Load nearby schools
        try {
          const response = await fetch(`/api/schools/${this.urn}/nearby?limit=5`);
          const data = await response.json();
          
          if (data.success && data.nearby_schools) {
            const nearbyHtml = data.nearby_schools.slice(0,5).map(school => `
              <div class="nearby-school" onclick="window.location.href='/school/${school.urn}'" 
                   style="cursor:pointer; padding:0.75rem 0; border-bottom:1px solid #f3f4f6;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <div>
                    <div style="font-weight:600; color:#111827; font-size:0.875rem;">${school.name}</div>
                    <div style="color:#6b7280; font-size:0.75rem;">${school.type_of_establishment || ''}</div>
                  </div>
                  <div style="font-weight:700; color:#2563eb; font-size:0.875rem;">${school.overall_rating || '-'}/10</div>
                </div>
              </div>
            `).join('');
            
            document.getElementById('nearbySchoolsList').innerHTML = nearbyHtml;
          }
        } catch (error) {
          console.error('Error loading nearby schools:', error);
        }
      }

      getOfstedLabel(rating) {
        const labels = { 1: 'Outstanding', 2: 'Good', 3: 'Requires Improvement', 4: 'Inadequate' };
        return labels[rating] || '-';
      }

      showError(message) {
        document.getElementById('schoolHeader').innerHTML = `
          <div class="container" style="padding: 2rem; text-align: center;">
            <h1 style="color: #ef4444;">${message}</h1>
          </div>
        `;
      }
    }

    // Initialize the page
    new SchoolPage();
  </script>
</body>
</html>